<!doctype html>
<html>
  <head>
    <title>OpenROV Browser proxy middleware</title>
  </head>
  <body>
    <ul id="messages"></ul>
    <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="js/socket.io-stream.js"></script>

    <script>
      var SocketStream = ss; // socket.io-stream imports as ss, make it more readable

      var host = 'build.openrov.com';
      if (window.location.hostname === 'localhost') {
        host = 'localhost';
      }
      var port = '3001';

      // Socket to the proxy service
      var middlewareSocket = io.connect('http://' + host + ':' + port);
      // Socket on the ROV
      var rovSocket = io.connect();

      middlewareSocket.on('connect', function() {
        $('#messages').append('<li>Connected to middleware</li>');
      });

      middlewareSocket.on('disconnect', function() {
        $('#messages').append('<li>Disconnected from middleware</li>');
      });

      middlewareSocket.on('proxy-error', function(error) {
        $('#messages').append('<li>Error on middleware: ' + JSON.stringify(error) +'</li>');
        rovSocket.emit('proxy-error', error);
      });

      rovSocket.on('connect', function() {
        $('#messages').append('<li>Connected to ROV</li>')
      });
      SocketStream(rovSocket).on('request', function(rovStream, url, callback){
        $('#messages').append('<li>Requested ' + JSON.stringify(url) + '</li>');

        // We got a request from the ROV HTTP proxy
        if (middlewareSocket && middlewareSocket.connected) {

          // create a stream to the proxy on the server
          // this will trigger the download of the requested file
          middlewareStream = SocketStream.createStream();
          SocketStream(middlewareSocket).emit('request', middlewareStream, url,
          function() {
            $('#messages').append('<li>End of stream ' + JSON.stringify(url) + '</li>');
            callback();
          });

          // we pipe the incoming data to the rovStream
          middlewareStream.on('data', function(data) {
            rovStream.write(data);
            console.log('#');
          });
          rovStream.on('data', function(data) {
            middlewareStream.write(data);
            console.log('@');
          });
        }
      });
      rovSocket.on('disconnect', function() {
        $('#messages').append('<li>Disconnected from ROV</li>');
      });

</script>
  </body>
</html>